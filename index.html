<!DOCTYPE html>
<html>
<head>
	<title>请稍候</title>
</head>
<body>
	<p>请稍候...</p>
<script>
	
function is_num(str) {
	return /^\d+$/.test(str);
}

function trans(s){
	var result="";
	//s = s.trim();
	for (var i =0;i<s.length;i++){
		if(is_num(s[i]) || s[i]=='\n'){
			result+=s[i];
		}
	}
	return result;
}

function validateIP(ip) {
	const ipRegex = /^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$/;
	return ipRegex.test(ip);
}

function getPublicIP(callback) {
	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function() {
		if(xhr.readyState === 4 && xhr.status === 200) {
			var response = JSON.parse(xhr.responseText);
			if(validateIP(response.ip)){
				callback(response.ip);
			}
		}
	};
	xhr.open("GET", "https://api.ipify.org?format=json", true);
	xhr.send();
}
	
function test() {
	var xmlhttp = new XMLHttpRequest();
	var fileUrl = "test.txt";
	xmlhttp.open("GET", fileUrl, true);

	xmlhttp.onreadystatechange = function () {
		if (this.readyState == 4 && this.status == 200) {
			var s = xmlhttp.responseText;
			//console.log(s);
			//document.write(fileContent);
			s = trans(s);
			var v = s.split("\n");
			var temp_ip="";
			for (var i =v.length-2;i>=0;i--){
				//v[i]=trans(v[i].toString());
				//console.log("i:",i);
				//console.log(v[i]);
				if(i!=v.length-2){
					temp_ip+=".";
				}
				/*if(v[i]==undefined){
					continue
				}*/
				temp_ip+=v[i];
				
			}
			console.log(temp_ip);
			getPublicIP(function(publicIP){
				if(temp_ip == publicIP){
					temp_ip="192.168.0.107";
					window.location.replace("http://"+temp_ip+":2997/temp/eweb/client.html");
				}
			});
			
		}
	};
	xmlhttp.send();
}

test();
	
</script>
</body>
	
</html>
