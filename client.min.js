function print(e){console.log(e);e=document.getElementById("status").textContent+" "+e.toString();200<(e=e.replace("\n"," ")).length&&(e=e.slice(e.length-200,e.length)),document.getElementById("status").textContent=e}function wordArrayToBuffer(e){for(var t=e.words,n=e.sigBytes,r=new Uint8Array(n),i=0;i<n;i++){var s=t[i>>>2]>>>24-i%4*8&255;r[i]=s}return r}function bufferToWordArray(e){for(var t=e.length,n=[],r=0;r<t;r++)n[r>>>2]|=(255&e[r])<<24-r%4*8;return CryptoJS.lib.WordArray.create(n,t)}function hexStringToUint8Array(t){var n=t.length/2,r=new Uint8Array(n);for(let e=0;e<n;e++){var i=t.substr(2*e,2),i=parseInt(i,16);r[e]=i}return r}function addButton(e,t){var n=document.querySelector(e),r=document.createElement("button");r.textContent=t,r.addEventListener("click",function(){".button-container"==e?sendWithEncrypt(stringToArrayBuffer("run_cmd\n"+t)):".button-list"==e?sendWithEncrypt(stringToArrayBuffer("get_file\n"+t)):".note-list"==e&&(sendWithEncrypt(stringToArrayBuffer("get_note\nnote/"+t)),cur_note=t,document.getElementById("rename_input").value=cur_note,document.getElementById("note_save").textContent="保存")}),n.appendChild(r)}function initPage(){for(var e=["ls","pwd","ps -aux","ifconfig","df -l","fdisk -l","date -R","uptime -p","smartctl --scan","smartctl -A /dev/sda","cat /proc/version","uname -a","service --status-all","dpkg --list","netstat -an","netstat -ltunp"],t=0;t<e.length;t++)addButton(".button-container",e[t])}var ws;function findBytes(e,n){var r=new DataView(e);let i=0;for(;i<r.byteLength-n.length+1;){if(r.getUint8(i)===n[0]){let t=!0;for(let e=1;e<n.length;e++)if(r.getUint8(i+e)!==n[e]){t=!1;break}if(t)return i}i++}return-1}function parse_message(e){var t=findBytes(e,new Uint8Array([10,0]));return[e.slice(0,t),e.slice(t+2,e.byteLength)]}function decode_bytes(e){return new TextDecoder("utf-16le").decode(e)}class FileReceiver{constructor(){this.clear()}clear(){this.file_data=null,this.file_name=null,this.file_size=0,this.received_size=0}process_message(e){var t;null===this.file_name?([this.file_name,t]=parse_message(e),this.file_name=decode_bytes(this.file_name),t=decode_bytes(t),this.file_size=parseInt(t),this.file_data=new Uint8Array(this.file_size),print(`开始接收文件：${this.file_name}，大小为：`+this.file_size)):(this.file_data.set(new Uint8Array(e),this.received_size),this.received_size+=e.byteLength,this.received_size>=this.file_size&&(print("接收完成："+this.file_name),t=new Blob([this.file_data],{type:"application/octet-stream"}),saveAs(t,this.file_name),this.clear()))}}class NoteReceiver{constructor(){this.clear()}clear(){this.file_data=null,this.file_name=null,this.file_size=0,this.received_size=0}process_message(e){var t;null===this.file_name?([this.file_name,t]=parse_message(e),this.file_name=decode_bytes(this.file_name),t=decode_bytes(t),this.file_size=parseInt(t),this.file_data=new Uint8Array(this.file_size),print(`开始接收文件：${this.file_name}，大小为：`+this.file_size)):(this.file_data.set(new Uint8Array(e),this.received_size),this.received_size+=e.byteLength,this.received_size>=this.file_size&&(print("接收完成："+this.file_name),document.getElementById("note_area").value=decode_bytes(this.file_data.slice(2,this.file_size)),this.clear()))}}var cur_note,keyBv,ivBv,keyWA,ivWA,receiver=new FileReceiver,note_receiver=new NoteReceiver,g_status="wait_rsa",g_jsencrypt=new JSEncrypt;function decryptU8arry(e){e=(contentWA=bufferToWordArray(e)).toString(CryptoJS.enc.Base64);return wordArrayToBuffer(CryptoJS.AES.decrypt(e,keyWA,{iv:ivWA,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}))}function encryptU8arry(e){(contentWA=bufferToWordArray(e)).toString(CryptoJS.enc.Base64);return wordArrayToBuffer(CryptoJS.AES.encrypt(contentWA,keyWA,{iv:ivWA,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).ciphertext)}function sendWithEncrypt(e){ws.send(encryptU8arry(new Uint8Array(e)).buffer)}function saveNote(e){var t;print(cur_note),null!=cur_note&&(t=stringToArrayBuffer("\ufeff"+document.getElementById("note_area").value),sendWithEncrypt(stringToArrayBuffer("send_file\nnote/"+cur_note+"\n"+t.byteLength.toString())),sendBig(t,t.byteLength),document.getElementById("note_save").textContent="保存")}function existName(e,t){for(var n=document.querySelector(t).childNodes,r=0;r<n.length;r++)if(e==n[r].textContent)return!0;return!1}function newNote(e){for(var t=0;t<1e5;t++){var n="新建笔记_"+t.toString()+".txt";if(!existName(n,".note-list"))break}cur_note=n,document.getElementById("note_area").value="",saveNote(),sendWithEncrypt(stringToArrayBuffer("list_note\n"))}function renameNote(e){var t;""==document.getElementById("rename_input").value||existName(t=document.getElementById("rename_input").value,".note-list")||null==cur_note||(sendWithEncrypt(stringToArrayBuffer("del_note\n"+cur_note)),cur_note=t,saveNote(),sendWithEncrypt(stringToArrayBuffer("list_note\n")))}function handleNoteInput(){document.getElementById("note_save").textContent="保存 *"}function login(e){var r=CryptoJS.SHA256(CryptoJS.SHA256(document.getElementById("password").value).toString()).toString(),s=(document.getElementById("password").value="",e.target);(ws=new WebSocket("wss://144.34.189.246:443")).onopen=function(){print("onopen"),ws.send("init_rsa")},ws.onmessage=function(e){if("wait_rsa"==g_status){g_jsencrypt.setPublicKey(e.data);var t=new Uint8Array(32),t=(crypto.getRandomValues(t),Array.from(t).map(e=>e.toString(16).padStart(2,"0")).join("")),n=(ivBv=new Uint8Array(16),crypto.getRandomValues(ivBv),Array.from(ivBv).map(e=>e.toString(16).padStart(2,"0")).join(""));ws.send(g_jsencrypt.encrypt(t+" "+r+" "+n)),r="",keyBv=hexStringToUint8Array(t),g_status="wait_verify"}else if("wait_verify"==g_status)"verified"==e.data&&(g_status="verified",keyWA=bufferToWordArray(keyBv),ivWA=bufferToWordArray(ivBv),print(s.textContent),"登录命令行"===s.textContent?(document.getElementsByClassName("login-section")[0].style.display="none",document.getElementsByClassName("chat-section")[0].style.display="block",initPage()):"登录网盘"===s.textContent?(document.getElementsByClassName("login-section")[0].style.display="none",document.getElementsByClassName("pan-section")[0].style.display="block",sendWithEncrypt(stringToArrayBuffer("list_file\n"))):"登录笔记"===s.textContent&&(document.getElementsByClassName("login-section")[0].style.display="none",document.getElementsByClassName("note-section")[0].style.display="block",sendWithEncrypt(stringToArrayBuffer("list_note\n"))));else{const i=new FileReader;i.onload=()=>{var e=i.result,[e,t]=parse_message(decryptU8arry(new Uint8Array(e)).buffer);if(print(e=decode_bytes(e)),"run_cmd_result"==e)cmd_result.innerHTML=decode_bytes(t);else if("get_file_result"==e)receiver.process_message(t);else if("get_note_result"==e)note_receiver.process_message(t);else if("list_file_result"==e){var n=(t=decode_bytes(t)).split("\n");document.querySelector(".button-list").innerHTML="";for(var r=0;r<n.length;r++)0!=n[r].length&&addButton(".button-list",n[r])}else if("list_note_result"==e){n=(t=decode_bytes(t)).split("\n");document.querySelector(".note-list").innerHTML="";for(r=0;r<n.length;r++)0!=n[r].length&&addButton(".note-list",n[r])}},i.readAsArrayBuffer(e.data)}},ws.onclose=function(e){print("WebSocket连接已关闭")},ws.onerror=function(e){print("WebSocket连接发生错误")}}function stringToArrayBuffer(t){var e=new ArrayBuffer(2*t.length),n=new Uint16Array(e);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return e}function concatArrayBuffers(e,t){var n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n.buffer}function sendBig(e,t){for(var n=0,r=Math.min(65536,t);n<t;){var i=e.slice(n,r);sendWithEncrypt(concatArrayBuffers(stringToArrayBuffer("send_file\n"),i)),n=r,r=Math.min(n+65536,t)}}function sendMessage(){sendWithEncrypt(stringToArrayBuffer("run_cmd\n"+document.getElementById("input").value))}function test(){var t=new XMLHttpRequest;t.open("GET","test.txt",!0),t.onreadystatechange=function(){var e;4==this.readyState&&200==this.status&&(e=t.responseText,console.log(e),document.write(e))},t.send(),document.write("Hello World!<br>"),document.write("Hello World!<br>")}function test99(){var e=new JSEncrypt,e=(e.setPublicKey("-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAlo6C9J181Ll93M0yKsOA\nZsganssSxeInpbvoJppNuGph0WK+6CypaSM+uQPbfoISaeSAoBDtaBkYcPN12cHL\nRNdaVB9airfZXSVfvnwARrde24PUgLqJZlibD90LEznXGrgufO8rpATsT7piBhh9\nrEnvtEMDMlWgsWEQO7OBX77v9Zo+yh5+ZUr82/NgCfPhJAtedm55dhHEh59UVwzs\nlt+zFYm75wv78A+unu4VRSM52p1NhtXQPd4WV6Im2C4Wffj+VoMcR7REZcPNMTEh\nxSO0HutDE3y6sCoXwU6cV/0B604LHXJWIi2mZRKP/fcdqGOlK+JmH1ETThXTWjxn\nUQIDAQAB\n-----END PUBLIC KEY-----"),e.encrypt("abc1")),t=new JSEncrypt,t=(t.setPrivateKey("-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEAlo6C9J181Ll93M0yKsOAZsganssSxeInpbvoJppNuGph0WK+\n6CypaSM+uQPbfoISaeSAoBDtaBkYcPN12cHLRNdaVB9airfZXSVfvnwARrde24PU\ngLqJZlibD90LEznXGrgufO8rpATsT7piBhh9rEnvtEMDMlWgsWEQO7OBX77v9Zo+\nyh5+ZUr82/NgCfPhJAtedm55dhHEh59UVwzslt+zFYm75wv78A+unu4VRSM52p1N\nhtXQPd4WV6Im2C4Wffj+VoMcR7REZcPNMTEhxSO0HutDE3y6sCoXwU6cV/0B604L\nHXJWIi2mZRKP/fcdqGOlK+JmH1ETThXTWjxnUQIDAQABAoIBAALGImyOYEftGQAR\n+cwm6P07z53AYRqrRY68rRTU//yXXTEF8D2H4SEySIwRIaCtldhEoQgR98XUvIoM\nOk4mT2/3xc7J+xmWNJeOQjrYvwqOg11pCufKSBDOLiE3MeaLSMbRwO2FXJj7jD0V\n0ouJNPuRKyz3lR3+zOSnxKxM7OPOMhEVLdU5qKMvo3bnLolDGIBxgVL1v5muMv+L\nTY5WyCcCu5rGp3EaWfYE72woKQrmjJGvi9YAIs+E3hqIDW5wte+L2KdGq1PE89k4\ndLsBhU2Ms0t3QYcvlWOkMqREQ2jI1L7vT5Iurp4szp2YNlp31qLskLct8cJOaDlF\nhwNcpQECgYEAvH2SUefbGjq3i/6HpAWnTEeaVOhbE3zmefzIvzcz6hEABedkPq7M\nGdxVZZuWryCLdDzooDQDLPjb9BLX7z0W5MRejF9JwAyVByp+2ny6vekNjkv2XnjZ\nrsYj9+dBSMOtPTyEciDJVUuD+gLzZ+qrh0gNSYZjH8U2e6zx+OibzjECgYEAzHrX\nSY0/7Bi1b7Cn9So4faNNyYkvKJyrhK/gNSkau/faPu8gCWihmvnHVggzNZSDiBV3\nS8owfdE2yrsOtCmHsOAhBzGQXibsA6Jz6xSpNOKNVFMa2AB7s/0xNUWqmW0KAtnQ\nKysJTCG6yNAww6a0082VuAe6pnHQRuwjQ04wQyECgYBa6oq4HQiO10GPMf9E+0Ed\nxu/HAqhjdvxIXMiLitnsjbSgJGMy5OcnliJOt0RwRlddgr+F/nCFsaeOS8SB7cps\nH9enB5MwIiGD6lhzlHQShCX4u+Ui3lHJPmM9APt5WIDoJ5eO4Qebr6gB4Ih9WDDS\nOMvH6h1Hxr0n3Fx+fdwhEQKBgC0M93e+BhJXU0obSrXqKm4L16yKa/hvpB5kvWoY\n90nojo4FEzLfeZNyaqeawOWSJfSKfjEVh9+Ag6jg05l/+ORQTRaPpfYIb0FRvmZR\ntAHx1B96+9QRLy/1nazV/4M0EduU75dDMRYz7DooHEZO6VIs3kqgcVAQjUnC5vYC\nOQHhAoGBAI9nrkmlBYBDCJq50tFtON7pkx6zv+2mst1u0aeHu4VGR0H+W+KEfDRT\nz27aFPvuIrQR7PmWdFDvbqrT9BwZxXDFjG8fctyi9fnBtllQ1VWXPhUJbvhFSS+m\npEBuFiwTNieG18syfUrXSJgB14E4pMw7N/crfClj5QwpeiOCh/bc\n-----END RSA PRIVATE KEY-----"),t.decrypt(e)),e=(print("abc1"),print(e),print(typeof e),print(t),[38,175,226,26,12,22,115,84,19,253,104,221,143,160,183,193,87,166,144,255,205,179,84,97,16,7,213,126,219,30,76,17]),t=[21,76,211,85,254,161,255,1,0,52,171,34,8,79,19,7],e=(console.log(t.length,e.length),new Uint8Array(e)),t=new Uint8Array(t),e=bufferToWordArray(e),t=(console.log(e),bufferToWordArray(t));var n=new Uint8Array([5,1,2,3,4]),n=((contentWA=bufferToWordArray(n)).toString(CryptoJS.enc.Base64),wordArrayToBuffer(CryptoJS.AES.encrypt(contentWA,e,{iv:t,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7}).ciphertext)),n=(console.log(n),n=(contentWA=bufferToWordArray(n=n)).toString(CryptoJS.enc.Base64),wordArrayToBuffer(CryptoJS.AES.decrypt(n,e,{iv:t,mode:CryptoJS.mode.CBC,padding:CryptoJS.pad.Pkcs7})));console.log(n)}document.querySelector("form").addEventListener("submit",function(e){e.preventDefault();var r=document.querySelector('input[type="file"]').files[0],i=new FileReader;i.onload=function(){for(var e=i.result,t=(print(e.byteLength),r.name),n=0;existName(t,".button-list");)t=n.toString()+"_"+r.name,n++;sendWithEncrypt(stringToArrayBuffer("send_file\n"+t+"\n"+e.byteLength.toString())),sendBig(e,e.byteLength),sendWithEncrypt(stringToArrayBuffer("list_file\n"))},i.readAsArrayBuffer(r)});
